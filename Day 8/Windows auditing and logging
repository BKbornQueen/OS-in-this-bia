Day 8 Windows Logging
FG
https://os.cybbh.io/public/os/latest/011_windows_auditing_&_logging/artifacts_fg.html


PS C:\> Get-LocalUser | select Name,SID 
PS C:\> Get-WmiObject win32_useraccount | select name,sid
C:\windows\system32>wmic UserAccount get name,sid 



The UserAssist registry key tracks the GUI-based programs that were ran by a particular user.
2.1 Location

They are located in HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Explorer\UserAssist\{GUID}\Count\ * they are encoded in ROT13

The GUID represents a particular file extension.

    CEBFF5CD-ACE2-4F4F-9178-9926F41749EA A list of applications, files, links, and other objects that have been accessed

    F4E57C4B-2036-45F0-A9AB-443BCFE33D9F Lists the Shortcut Links used to start programs

PS C:\> Get-ItemProperty "HKCU:\Software\Microsoft\Windows\CurrentVersion\Explorer\UserAssist\{CEBFF5CD-ACE2-4F4F-9178-9926F41749EA}\Count"
  Output shows the Executable files encoded with ROT13. Copy/ Paste the output into a decdoer site like Rot13 or CyberChef


Q: Where can you look to pull all users that have logged on to the computer and have ran executables?

Q: How can we change our command to look at all users Userassist artifacts?

A: From

PS C:\> Get-ItemProperty "HKCU:\Software\Microsoft\Windows\CurrentVersion\Explorer\UserAssist\{CEBFF5CD-ACE2-4F4F-9178-9926F41749EA}\Count"

To

PS C:\> Get-ItemProperty "Registry::Hkey_Users\*\Software\Microsoft\Windows\CurrentVersion\Explorer\UserAssist\{CEBFF5CD-ACE2-4F4F-9178-9926F41749EA}\Count"

powershell is normally launched from system32 so it is an anomaly for a user to run it from 
their home folder. It is suscpicous activity



Show in Reg Edit:
HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\bam\State\UserSettings #On 1809 and Newer

HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\bam\UserSettings #On 1803 and below

systeminfo

Get-ComputerInfo | select osname,osversion,OsHardwareAbstractionLayer


see student guide for user build

BAM

PS C:\> Get-Item HKLM:\SYSTEM\CurrentControlSet\Services\bam\state\UserSettings\*
Output shows all users BAM artifacts

PS C:\> wmic useraccount  get caption,sid | more
S C:\> Get-Itemproperty 'HKLM:\SYSTEM\CurrentControlSet\Services\bam\State\UserSettings\S-1-5-21-1584283910-3275287195-1754958050-1005' 
Get the SID of every local user on the machine
	Insert the SID of andy.dwyer from above. Output shows the BAM artifact from andy.dwyer


Content in the recycle bin is identified by:

    SID - determines which user deleted it

    Timestamp - When it was deleted

    $RXXXXXX - content of deleted files

    $IXXXXXX - original PATH and name

C:\$Recycle.bin (Hidden System Folder)

PS C:\> Get-Childitem 'C:\$RECYCLE.BIN' -Recurse -Verbose -Force | select FullName
Output shows all of the contents of the Recycle Bin. -Recurse will look at all user’s/SID’s contents
PS C:\> wmic useraccount where 'sid="S-1-5-21-1584283910-3275287195-1754958050-1005"' get name
 	To find Recycle Bin artifacts for a specific user, match the SID, then append it to the previous command:
  Match SID to USER

PS C:\> Get-Content 'C:\$Recycle.Bin\S-1-5-21-1584283910-3275287195-1754958050-1005\$R8QZ1U8.txt' 
 	Reads the contents of a particular file within the Recycle BIN

Prefetch
Prefetch files are created by the windows operating system when an application is run from a specific location for the first time.
find evidence of program execution
allows you to reopen a program quickly- ie loads faster the second time bc the system knows how to get there and where to go



The prefetch files are stored in “\Root\Windows\Prefetch” folder.
* Analysis of prefetch files reveals the evidence of the intial program execution for a user and from a specific location at a specific time.
By default, Windows Server does not have Prefetch enabled.

Prefetch entries record the location of the associated executable and files referenced by that executable. Look for any files executed or referenced from a temp directory as this is typically an outlier.
Use Eric Zimmerman’s PECmd.exe utility to analyze Prefetch data

General Format of a prefetch file: (exename)-(hash-of-path).pf
PS C:\> Get-Childitem -Path 'C:\Windows\Prefetch' -ErrorAction Continue | select -First 8 


jumplists frequently visited items
PS C:\> Get-Childitem -Recurse C:\Users\*\AppData\Roaming\Microsoft\Windows\Recent -ErrorAction Continue | select FullName, LastAccessTime



recently used programs
PS C:\> Get-Childitem -Recurse C:\Users\*\AppData\Roaming\Microsoft\Windows\Recent -ErrorAction Continue | select FullName, LastAccessTime

Query the Hex Value Stored in the Key
PS C:\> Get-Item 'Registry::\HKEY_USERS\*\Software\Microsoft\Windows\CurrentVersion\Explorer\RecentDocs\.*'
With the * we can see the types of files/ information that was recently viewed.


PS C:\> Get-Winevent -FilterHashtable @{logname='Security';id='4624'} | ft -Wrap 
gives logged on users
google event id numbers for specific thing

2.1 Location

They are located in HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Explorer\UserAssist\{GUID}\Count\ * they are encoded in ROT13

The GUID represents a particular file extension.

    CEBFF5CD-ACE2-4F4F-9178-9926F41749EA A list of applications, files, links, and other objects that have been accessed

    F4E57C4B-2036-45F0-A9AB-443BCFE33D9F Lists the Shortcut Links used to start programs



monitoring
auditing
\System32\WinEvt\Logs\System.evtx
security
NT AUTHORITY\SYSTEM
SACL
HKLM\Security\Policy\PolAdtEv
PsLogList ////section8.2
strings
HKCU:\Software\Microsoft\Windows\CurrentVersion\Explorer\RecentDocs
ver //// (<#>)
PS C:\> Get-Childitem -Recurse C:\<fullpathofFile> -ErrorAction Continue | select FullName, LastAccessTime
C:\Windows\Prefetch
$R
$I
HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Explorer\UserAssist\{GUID}\Count\
ROT13
security
system
-wrap
	PS C:\windows\system32> net use * http://live.sysinternals.com
	PS C:\> Z:\strings.exe 'C:\users\andy.dwyer\AppData\Local\Google\Chrome\User Data\Default\History' -accepteula 
https://www.exploit-db.com/
